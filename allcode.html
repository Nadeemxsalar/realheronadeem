<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modern Auth UI with Supabase</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      scroll-behavior: smooth;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #f0f4ff, #e9f0fb);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      animation: fadeInBody 1s ease-in;
    }

    @keyframes fadeInBody {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    nav {
      width: 100%;
      padding: 1rem 2rem;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    nav h1 {
      font-size: 1.3rem;
      color: #333;
      font-weight: bold;
    }

    .nav-links {
      display: flex;
      gap: 1.2rem;
    }

    .nav-links a {
      text-decoration: none;
      color: #555;
      font-weight: 500;
      position: relative;
    }

    .nav-links a::after {
      content: "";
      height: 2px;
      width: 0%;
      position: absolute;
      bottom: -4px;
      left: 0;
      background: #66aaff;
      transition: 0.3s ease;
    }

    .nav-links a:hover::after {
      width: 100%;
    }

    .hamburger {
      display: none;
      flex-direction: column;
      gap: 5px;
      cursor: pointer;
    }

    .hamburger span {
      width: 25px;
      height: 3px;
      background: #555;
      border-radius: 3px;
    }

    @media (max-width: 768px) {
      .nav-links {
        display: none;
        flex-direction: column;
        position: absolute;
        background: #fff;
        right: 2rem;
        top: 60px;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .nav-links.active {
        display: flex;
      }

      .hamburger {
        display: flex;
      }
    }

    .container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    .auth-box {
      background: rgba(255, 255, 255, 0.18);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      max-width: 400px;
      width: 100%;
      animation: fadeInUp 0.8s ease-out;
      transition: transform 0.3s ease;
    }

    @keyframes fadeInUp {
      from {
        transform: translateY(40px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 2rem;
    }

    .input-group {
      margin-bottom: 1rem;
    }

    input {
      width: 100%;
      padding: 0.9rem 1rem;
      border-radius: 10px;
      border: 1px solid rgba(200, 200, 200, 0.5);
      background: rgba(255, 255, 255, 0.8);
      transition: 0.3s;
      font-size: 1rem;
      color: #333;
      outline: none;
    }

    input:focus {
      border-color: #66aaff;
      box-shadow: 0 0 6px #66aaff88;
    }

    .error {
      color: #d9534f;
      font-size: 0.85rem;
      margin-top: 4px;
    }

    button {
      width: 100%;
      padding: 0.9rem;
      border: none;
      border-radius: 10px;
      background: linear-gradient(to right, #66aaff, #5c7eff);
      color: #fff;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.3s;
    }

    button:hover {
      opacity: 0.9;
      transform: scale(1.02);
    }

    .or-divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 1.5rem 0;
    }

    .or-divider::before,
    .or-divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #ccc;
    }

    .or-divider:not(:empty)::before {
      margin-right: .5em;
    }

    .or-divider:not(:empty)::after {
      margin-left: .5em;
    }

    .google {
      background: linear-gradient(to right, #db4437, #f4b400);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.6rem;
    }

    .google span {
      font-size: 1.2rem;
    }

    .link-btn {
      display: block;
      text-align: center;
      margin-top: 1rem;
      color: #555;
      font-size: 0.9rem;
      text-decoration: none;
      cursor: pointer;
    }

    .link-btn.disabled {
      color: #999;
      cursor: not-allowed;
    }

    .spinner {
      display: none;
      width: 32px;
      height: 32px;
      margin: 1rem auto;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top: 4px solid #66aaff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .tick {
      display: none;
      text-align: center;
      font-size: 2rem;
      color: #28a745;
      margin-top: 1rem;
    }

    .snackbar {
      visibility: hidden;
      min-width: 200px;
      background: #444;
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 0.75rem;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 99;
    }

    .snackbar.show {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>

<body>
  <nav>
    <h1>MyApp</h1>
    <div class="nav-links" id="navLinks">
      <a href="#">Home</a>
      <a href="#">About</a>
      <a href="#">Contact</a>
    </div>
    <div class="hamburger" onclick="toggleMenu()">
      <span></span><span></span><span></span>
    </div>
  </nav>

  <div class="container">
    <div class="auth-box">
      <form onsubmit="handleSubmit(); return false;">
        <h2 id="formTitle">Login</h2>
        <div class="input-group" id="usernameGroup" style="display:none;">
          <input type="text" id="username" placeholder="Username" autocomplete="username">
          <div class="error" id="usernameError"></div>
        </div>
        <div class="input-group">
          <input type="email" id="email" placeholder="Email" autocomplete="email">
          <div class="error" id="emailError"></div>
        </div>
        <div class="input-group" id="passwordGroup">
          <input type="password" id="password" placeholder="Password" autocomplete="current-password">
          <div class="error" id="passwordError"></div>
        </div>
        <div class="input-group" id="otpGroup" style="display:none;">
          <input type="text" id="otp" placeholder="Enter OTP received in email" autocomplete="one-time-code">
          <div class="error" id="otpError"></div>
        </div>
        <div class="link-btn" id="resendOtpLink" style="display:none;" onclick="resendOtp()">Resend OTP</div>

        <div class="spinner" id="spinner"></div>
        <button type="submit" id="submitButton">Login</button>
      </form>

      <div class="or-divider">Or</div>
      <button class="google" onclick="handleGoogle()">Sign in with Google <span>G</span></button>

      <div id="auth-links">
        <div class="link-btn" id="signupLink" onclick="toggleMode()">Don't have an account? Sign up</div>
        <div class="link-btn" id="forgotPasswordLink" onclick="forgotPassword()">Forgot Password?</div>
        <div class="link-btn" id="otpModeLink" onclick="toggleOtpMode()">Login with Email OTP instead</div>
        <div class="link-btn" id="passwordModeLink" style="display:none;" onclick="toggleOtpMode()">Login with Password
          instead</div>
      </div>
      <div class="tick" id="successTick">✔️</div>
    </div>
  </div>

  <div class="snackbar" id="snackbar"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const SUPABASE_URL = "https://htrpbywoaxqymgwilvot.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0cnBieXdvYXhxeW1nd2lsdm90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MDQxOTksImV4cCI6MjA2NzE4MDE5OX0.Wo_UyilZsPcuefw8RIMU4CPJS6JKrawLwUcxNYEWxeg";
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- STATE VARIABLES ---
    let isLoginMode = true;
    let isOtpMode = false;
    let otpSent = false;
    let isVerifyingSignup = false;
    let resendTimer; // NEW: Timer variable

    // --- UI HELPER FUNCTIONS ---
    window.toggleMenu = () => document.getElementById('navLinks').classList.toggle('active');
    const showSpinner = val => document.getElementById('spinner').style.display = val ? 'block' : 'none';
    const showSnackbar = msg => {
      const sb = document.getElementById('snackbar');
      sb.innerText = msg;
      sb.classList.add('show');
      setTimeout(() => sb.classList.remove('show'), 3000);
    };
    const showSuccess = () => {
      showSpinner(false);
      document.getElementById('successTick').style.display = 'block';
      setTimeout(() => { window.location.href = 'index.html'; }, 1200);
    };

    // --- MODE TOGGLING & UI ---
    window.toggleMode = () => {
      isLoginMode = !isLoginMode;
      document.getElementById('formTitle').innerText = isLoginMode ? 'Login' : 'Sign Up';
      document.getElementById('submitButton').innerText = isLoginMode ? 'Login' : 'Sign Up';
      document.getElementById('usernameGroup').style.display = isLoginMode ? 'none' : 'block';
      document.getElementById('forgotPasswordLink').style.display = isLoginMode ? 'block' : 'none';
      document.getElementById('signupLink').innerHTML = isLoginMode ? "Don't have an account? Sign up" : "Already have an account? Login";
    };

    window.toggleOtpMode = () => {
      isOtpMode = !isOtpMode;
      otpSent = false;
      const formTitle = document.getElementById('formTitle');
      const submitButton = document.getElementById('submitButton');
      const passwordGroup = document.getElementById('passwordGroup');
      const otpGroup = document.getElementById('otpGroup');
      const passwordModeLink = document.getElementById('passwordModeLink');
      const otpModeLink = document.getElementById('otpModeLink');
      const signupLink = document.getElementById('signupLink');
      const forgotPasswordLink = document.getElementById('forgotPasswordLink');
      const emailInput = document.getElementById('email');
      const resendOtpLink = document.getElementById('resendOtpLink');

      clearInterval(resendTimer); // Clear timer when switching modes
      resendOtpLink.style.display = 'none';

      if (isOtpMode) {
        formTitle.innerText = 'Login with OTP';
        submitButton.innerText = 'Send OTP';
        passwordGroup.style.display = 'none';
        otpGroup.style.display = 'none';
        signupLink.style.display = 'none';
        forgotPasswordLink.style.display = 'none';
        otpModeLink.style.display = 'none';
        passwordModeLink.style.display = 'block';
        emailInput.disabled = false;
      } else {
        formTitle.innerText = 'Login';
        submitButton.innerText = 'Login';
        passwordGroup.style.display = 'block';
        otpGroup.style.display = 'none';
        signupLink.style.display = 'block';
        forgotPasswordLink.style.display = 'block';
        otpModeLink.style.display = 'block';
        passwordModeLink.style.display = 'none';
        emailInput.disabled = false;
        if (!isLoginMode) toggleMode();
      }
    }

    const switchToOtpVerificationView = (email) => {
      isVerifyingSignup = true;
      document.getElementById('formTitle').innerText = 'Verify Your Account';
      document.getElementById('usernameGroup').style.display = 'none';
      document.getElementById('passwordGroup').style.display = 'none';
      document.getElementById('otpGroup').style.display = 'block';
      document.getElementById('auth-links').style.display = 'none';
      document.getElementById('submitButton').innerText = 'Verify Account';
      const emailInput = document.getElementById('email');
      emailInput.value = email;
      emailInput.disabled = true;
      document.getElementById('resendOtpLink').style.display = 'block';
      startResendTimer();
    }

    // --- NEW: OTP Timer and Resend Logic ---
    const startResendTimer = () => {
      let seconds = 30;
      const resendLink = document.getElementById('resendOtpLink');
      resendLink.classList.add('disabled');
      resendLink.onclick = null; // Disable click

      resendTimer = setInterval(() => {
        if (seconds > 0) {
          resendLink.innerText = `Resend OTP in ${seconds}s`;
          seconds--;
        } else {
          clearInterval(resendTimer);
          resendLink.innerText = 'Resend OTP';
          resendLink.classList.remove('disabled');
          resendLink.onclick = resendOtp; // Re-enable click
        }
      }, 1000);
    };

    window.resendOtp = async () => {
      const email = document.getElementById('email').value.trim();
      showSnackbar('Resending OTP...');
      // The type of OTP to resend depends on the context
      const otpType = isVerifyingSignup ? 'signup' : 'email';
      const { error } = await supabaseClient.auth.signInWithOtp({ email, options: { channel: otpType } });

      if (error) {
        showSnackbar(error.message);
      } else {
        showSnackbar('OTP has been resent to your email!');
        startResendTimer(); // Restart the timer
      }
    };


    // --- MAIN SUBMIT FUNCTION ---
    window.handleSubmit = async () => {
      document.querySelectorAll('.error').forEach(e => e.textContent = '');
      showSpinner(true);
      if (isVerifyingSignup) {
        await handleSignupVerification();
      } else if (isOtpMode) {
        await handleOtpLogin();
      } else {
        await handlePasswordLogin();
      }
      showSpinner(false);
    };

    // --- AUTH LOGIC FUNCTIONS ---
    const handlePasswordLogin = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!email) { document.getElementById('emailError').innerText = 'Required'; return; }
      if (!password && isLoginMode) { document.getElementById('passwordError').innerText = 'Required'; return; }

      if (isLoginMode) {
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) showSnackbar(error.message);
        else showSuccess();
      } else {
        const { data, error } = await supabaseClient.auth.signUp({ email, password });
        if (error) {
          showSnackbar(error.message);
        } else {
          const { error: otpError } = await supabaseClient.auth.signInWithOtp({ email });
          if (otpError) {
            showSnackbar(otpError.message)
          } else {
            showSnackbar('Sign up successful! Check your email for an OTP to verify.');
            switchToOtpVerificationView(email);
          }
        }
      }
    };

    const handleOtpLogin = async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) { document.getElementById('emailError').innerText = 'Email is required'; return; }

      if (!otpSent) {
        const { error } = await supabaseClient.auth.signInWithOtp({ email });
        if (error) {
          showSnackbar(error.message);
        } else {
          showSnackbar('OTP has been sent to your email!');
          otpSent = true;
          document.getElementById('otpGroup').style.display = 'block';
          document.getElementById('email').disabled = true;
          document.getElementById('submitButton').innerText = 'Verify OTP';
          document.getElementById('resendOtpLink').style.display = 'block';
          startResendTimer();
        }
      } else {
        const otp = document.getElementById('otp').value.trim();
        if (!otp) { document.getElementById('otpError').innerText = 'OTP is required'; return; }
        const { error } = await supabaseClient.auth.verifyOtp({ email, token: otp, type: 'email' });
        if (error) showSnackbar(error.message);
        else showSuccess();
      }
    };

    const handleSignupVerification = async () => {
      const email = document.getElementById('email').value.trim();
      const otp = document.getElementById('otp').value.trim();
      if (!otp) { document.getElementById('otpError').innerText = 'OTP is required'; return; }

      const { data, error } = await supabaseClient.auth.verifyOtp({ email: email, token: otp, type: 'signup' });
      if (error) {
        showSnackbar(error.message);
      } else {
        showSnackbar('Account verified successfully!');
        showSuccess();
      }
    };

    window.handleGoogle = async () => {
      showSpinner(true);
      const { data, error } = await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
      if (error) { showSnackbar('Google Sign-In failed: ' + error.message); }
      showSpinner(false);
    };

    window.forgotPassword = async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) return showSnackbar('Please enter your email to reset the password.');
      showSpinner(true);
      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
      if (error) { showSnackbar(error.message); }
      else { showSnackbar('Password reset link has been sent to your email.'); }
      showSpinner(false);
    };
  </script>
</body>

</html>
